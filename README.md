# edepViewer
An external event viewer for [edep-sim](https://github.com/ClarkMcGrew/edep-sim).

Warning:
  While I am personally using the develop branch of this project in my work, the project as a whole is still 
under development and contains numerous bugs.  Users are strongly encouraged to confirm surprising event 
features with edepsim's builtin event viewer, the edep-disp binary.  This library does not yet work on OS X 
and has been tested almost exclusively on Ubuntu 16.04 so far.    

## Overview:
  edepViewer visualizes events from edepsim with the minimal drawing details necessary while providing as much 
access to the information generated by edepsim as possible.  Quality visualizations should be produced with 
almost no configuration, but tools are provided to customize event navigation, which objects are drawn, and 
how edepsim objects are interpretted.   

## Installation: 
  edepViewer uses a CMake build system, so you will need at least CMake 3.5.1 to build the source code.  
1. Choose the build options you want to use from below and use them to create the Makefiles needed for the 
   build with "cmake /path/to/src/ [-Doption1 -Doption2 ...]" in a build area that is not the source directory.  
   CMake should make you aware of any missing dependencies.  
2. Make sure edep-sim is set up for running by sourcing its' setup.sh script.  This should set environment variables 
   EDEP_ROOT and EDEP_TARGET to point to where edepsim is installed.  
3. "make install" this package.  
4. You are ready to run edepViewer with "[CMAKE_INSTALL_PREFIX/bin/]EdepApp".  You will need to set up edepsim 
   with its' setup.sh script every time you want to run edepViewer.  

## Using the Viewer:
1. Run "EvdApp":
   Usage: EvdApp [configuration.xml one_edep_file.root another_edep_file.root ...]
           
   * If no files are provided on the command line, gets the [default.xml](conf/default.xml) 
     configuration file from the installation directory and pops up a GUI to choose one ROOT 
     file to view.  ROOT file should contain keys for the tree and geometry used by edep-sim.  

   * If any file names are provided on the command line, the application will not use the default 
     configuration file.  If just a configuration file is provided, the application should still 
     prompt the user for an edep-sim input file with a GUI.  

   * configuration.xml: Provide an xml configuration file.  Take a look at the default file, default.xml, in 
                        [conf](conf).  Requires a top-level node called "config" and child nodes "drawer" 
                        and "services".  "drawer" must have child nodes "global" and "event" for the two 
                        types of drawing algorithms.  "event" and "global" child nodes are the class names for 
                        drawing algorithms you want to use without namespaces.  

   * one_edep_file.root: File name to be given to [TFile::Open()](https://root.cern.ch/doc/master/classTFile.html#a427763ef8cde1b969643fc58fce712aa)
                         This means that local files and several kinds of remote files are supported.  I have 
                         found xrootd particularly useful for streaming large files I want to view from remote 
                         servers.  You may list more than one root file.   

2. The main viewer GUI should pop up as a new window:

  1. Click and drag in the main viewer area on the left to view the first edep-sim event from different angles.  
     Zoom in and out with a scroll wheel.  
     Move in the plane orthogonal to the camera direction with the arrow keys.
     Click on an object to highlight it both in the main viewer area and in the list-tree.  

  2. Go to the next event or a specific event with the control bar at the top of the GUI.  
     Select a new file to view with the "File" button.  
     Take a screenshot with the "Print" button.
     Reload the event, possibly undoing cuts, with the "Reload" button.  It should not be needed often.

  3. Interact with the viewer and object metadata in more detail from the list-tree pane on the right.  
     The Viewer pane can change the background color and provides finer control over the camera.

3. Object list-trees:
  1. There is one list-tree for each type of object drawn.   Each list-tree provides columns of metadata for the 
     objects of that type in the current tree.  

  2. The "Draw" column toggles whether each object is drawn individually.  Togling drawing for an object does 
     not toggle drawing for its' children.   

  3. The text entry at the top of each list-tree pane is the Cut Bar.  Type in the Cut Bar to specify a condition 
     for an object to be drawn:
 
   * Warning: The Cut Bar is very slow at the moment.  It works reasonably well for single events, but it can 
              cause more populous scenes like energy deposits to take several minutes to draw when moving to a 
              new event!  Set the cut bar's text to "true" and press the "Reload" button in the Control Bar to 
              redraw all objects in a scene.  

   * Each metadata column in a scene is identified by an index.  Since the "draw" column is column 0, the first 
     metadata column is labelled 1.  Specify a column value in a cut with "@<column number>" as in "@2 != neutron".  

   * Column values can be compared to any alpha-numeric value with the operators "==", "!=", "<", and ">".  The 
     Cut Bar should ignore cuts that try to compare numeric values to text columns and vice-versa.  
 
   * The cut bar is not yet smart enough to apply the order of operations correctly, so all comparison 
     expressions should be enclosed in parentheses.  "@2 != neutron" is OK, but "@2 != neutron && @3 > 5" 
     should have no effect because it is an error.  Replace the second example with 
     "(@2 != neutron) && (@3 > 5)".  

   * The results of boolean expressions are treated as booleans and can be combined with the "&&" and "||" 
     operators.  The strings "true" and "false" are interpretted as booleans when they appear in cuts.  
     So, a cut of "false" will completely stop drawing a scene.  

   * Objects removed by the Cut Bar are removed from the list-tree along with their children.  The children 
     may still be drawn if they pass the applied cut.   

CMake has lots of useful options for configuring the build, so I have listed a few that I use frequently when 
working with this package:
 
CMAKE_INSTALL_PREFIX     Set the /path/for/installation/.  Default seems to be /usr/local for me on Ubuntu 
                         16.04.  Will install in CMAKE_INSTALL_PREFIX/bin, CMAKE_INSTALL_PREFIX/lib, 
                         CMAKE_INSTALL_PREFIX/include, and CMAKE_INSTALL_PREFIX/conf.  

CMAKE_BUILD_TYPE         Could be Debug to install with symbols for a debugger like gdb or Build for slightly 
                         more optimization.  

This package also supports CPack, so you can "make package" if you need a tarball.  

## Dependencies:
[CMake 3.5.1](https://cmake.org/)

[edep-sim](https://github.com/ClarkMcGrew/edep-sim)            The package that produces the files that edepViewer reads.  
                                                               Defines the objects that edepViewer knows how to read.
  
[gtkmm 3.22.0](https://www.gtkmm.org/en/documentation.html)    Graphical User Interface used for information and control 
                                                               widgets.  Also provides some details for opengl rendering
                                                               at the moment, but that might need to change in the near 
                                                               future to support OS X.  

[ROOT 6](https://root.cern.ch/)                                Also a dependency of edep-sim, but I use it for file IO
                                                               and a few other odd utilities that help me deal with 
                                                               edep-sim files more easily.  Notably provides first step 
                                                               in geometry tesselation at the moment.  

[glm](https://glm.g-truc.net/0.9.8/index.html)                 Vector operations for interfacing with opengl.  

[tinyxml2](http://www.grinninglizard.com/tinyxml2/)            Very lightweight XML parser for configuration files.  
                                                               Not provided with source code at this time.  May be 
                                                               replaced by a yaml parser or ROOT's XML parser.

[glad](https://github.com/Dav1dde/glad)                        This source distribution includes code generated by the 
                                                               glad tool.  glad handles some details of working with 
                                                               opengl on multiple plateforms.


## Acknowledgements:
  I learned a lot about CMake and deploying an object from the source code of [edep-sim](https://github.com/ClarkMcGrew/edep-sim).  
Several of the [ROOT website's](https://root.cern.ch/) examples helped me to learn to use TTreeReader, and the documentation of 
ROOT classes has been extremely useful when developing this project.  I used the 
[gtkmm tutorial](https://developer.gnome.org/gtkmm-tutorial/stable/) to get started with writing the interface for this application.  
I learned nearly everything I know about opengl from [learnopengl.com](https://learnopengl.com/).  
